{% extends "base.html" %}

{% block title %}{% if video_title %}{{ video_title }}{% else %}{{ video_id }}{% endif %} - YouTube Deep Summary{% endblock %}

{% block content %}
    <div class="video-info">
        <div style="display: flex; align-items: flex-start; gap: 20px; margin-bottom: 20px;">
            <div style="flex-shrink: 0;">
                <img src="{{ thumbnail_url }}" 
                     alt="Video thumbnail" 
                     style="width: 320px; height: 180px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                     onerror="this.style.display='none'">
            </div>
            <div style="flex-grow: 1;">
                {% if video_title %}
                    <h2>{{ video_title }}</h2>
                    <p style="color: #666; margin: 5px 0;">
                        {% if video_uploader %}<strong><a href="https://www.youtube.com/results?search_query={{ video_uploader|urlencode }}" target="_blank" style="color: #0066cc; text-decoration: none;">{{ video_uploader }}</a></strong>{% endif %}
                        {% if video_duration %} ‚Ä¢ {{ "%.0f"|format(video_duration // 60) }}:{{ "%02.0f"|format(video_duration % 60) }} minutes{% endif %}
                    </p>
                {% else %}
                    <h2>üì∫ Video ID: {{ video_id }}</h2>
                {% endif %}
                <p><strong>YouTube URL:</strong> <a href="https://www.youtube.com/watch?v={{ video_id }}" target="_blank">https://www.youtube.com/watch?v={{ video_id }}</a></p>
                <p style="margin-top: 10px;">
                    <a href="https://www.youtube.com/watch?v={{ video_id }}" target="_blank" style="background: #ff0000; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; display: inline-block; margin-right: 10px;">‚ñ∂Ô∏è Watch on YouTube</a>
                    {% if summarize_enabled %}
                        <button id="generateSummaryBtn" onclick="generateSummary('{{ video_id }}')" style="background: #2196f3; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; display: inline-block;">ü§ñ {% if summary %}Regenerate AI Summary{% else %}Generate AI Summary{% endif %}</button>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <!-- Proxy info hidden 
    <div class="proxy-info">
        <strong>üåê Proxy used:</strong> {{ proxy_used }}
    </div>
    -->
    
    <details class="search-form-collapsed" style="margin-bottom: 20px;">
        <summary style="background: #f8f9fa; padding: 10px 15px; border-radius: 5px; cursor: pointer; border: 1px solid #ddd; outline: none;">
            üîç Search Another Video
        </summary>
        <div class="search-form" style="margin-top: 10px; border-top: 1px solid #ddd; padding-top: 15px;">
            <form action="/watch" method="get">
                <input type="text" name="v" placeholder="Enter another video ID or URL" value="{{ video_id }}">
                <button type="submit">Get Transcript</button>
                {% if summarize_enabled %}
                    <label style="margin-left: 10px;">
                        <input type="checkbox" name="summarize" value="true" {% if summary or summary_error %}checked{% endif %}>
                        Generate AI Summary
                    </label>
                {% endif %}
            </form>
        </div>
    </details>
    
    <!-- Generate AI Summary button moved to video info section -->
    
    <!-- Summary section - will be populated by JavaScript or shown if pre-loaded -->
    <div id="summary-section" style="{% if not summary and not summary_error %}display: none;{% endif %}">
        {% if summary %}
            <div class="summary-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ü§ñ AI-Generated Summary:</h3>
                    {% if summarize_enabled %}
                        <button id="regenerateSummaryBtn" onclick="regenerateSummary('{{ video_id }}')" style="background: #ff9800; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">üîÑ Regenerate</button>
                    {% endif %}
                </div>
                <div class="summary-content">
                    <div class="markdown-content">{{ summary|safe }}</div>
                </div>
            </div>
            <hr style="margin: 30px 0; border: 1px solid #ddd;">
        {% endif %}
        
        {% if summary_error %}
            <div class="summary-error">
                <h3>‚ùå Summary Error:</h3>
                <p style="color: #d32f2f;">{{ summary_error }}</p>
            </div>
            <hr style="margin: 30px 0; border: 1px solid #ddd;">
        {% endif %}
    </div>
    
    {% if chapters %}
        <div class="chapters-info">
            <h3>üìö Video Chapters ({{ chapters|length }} chapters):</h3>
            <ul style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0;">
                {% for chapter in chapters %}
                    <li><strong>{{ chapter.title }}</strong> - <a href="#chapter-{{ chapter.time|int }}" onclick="scrollToChapter({{ chapter.time|int }})" style="color: #0066cc; text-decoration: underline; cursor: pointer;">{{ "%.0f"|format(chapter.time // 60) }}:{{ "%02.0f"|format(chapter.time % 60) }}</a> <span style="color: #666; font-size: 0.9em;">(<a href="https://www.youtube.com/watch?v={{ video_id }}&t={{ chapter.time|int }}s" target="_blank" style="color: #999; text-decoration: none;" title="Watch on YouTube">‚ñ∂Ô∏è</a>)</span></li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}
    
    <div class="transcript-options" style="margin: 20px 0;">
        <button onclick="toggleTranscriptView()" id="toggleBtn" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
            üìñ Switch to Detailed View
        </button>
    </div>
    
    <h3>üìù Transcript ({{ transcript|length }} entries):</h3>
    
    <!-- Formatted readable transcript (default view) -->
    <div id="formatted-transcript" class="transcript-container" style="display: block;">
        <div class="formatted-text" style="background: #f9f9f9; padding: 15px; border-radius: 5px; line-height: 1.6; font-family: Georgia, serif;">
            <div id="formatted-transcript-content" style="white-space: pre-wrap; font-family: Georgia, serif; margin: 0;">{{ formatted_transcript|safe }}</div>
        </div>
    </div>
    
    <!-- Detailed timestamp transcript (hidden by default) -->
    <div id="detailed-transcript" class="transcript-container" style="display: none;">
        {% for entry in transcript %}
            <div class="transcript-entry" data-time="{{ entry.time|int }}" id="timestamp-{{ entry.time|int }}">
                <div class="timestamp">[{{ entry.formatted_time }}] ({{ "%.2f"|format(entry.time) }}s)</div>
                <div class="text">{{ entry.text }}</div>
            </div>
        {% endfor %}
    </div>
    
    <!-- Floating "Add to Snippets" button -->
    <button id="snippetsAddBtn" class="memory-add-button" style="display: none;" onclick="addToSnippets()">
        ‚úÇÔ∏è Add to Snippets
    </button>
    
    <script>
        // Snippets functionality variables
        let selectedText = '';
        let sourceType = '';
        
        // Initialize snippets functionality when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSnippetsSelection();
            addSnippetButtonsToExistingSummary();
        });
        
        function initializeSnippetsSelection() {
            // Add event listeners for text selection
            document.addEventListener('mouseup', handleTextSelection);
            document.addEventListener('keyup', handleTextSelection);
        }
        
        function handleTextSelection() {
            const selection = window.getSelection();
            const selectedTextContent = selection.toString().trim();
            
            if (selectedTextContent.length > 0) {
                // Determine if selection is from transcript or summary
                const range = selection.getRangeAt(0);
                const container = range.commonAncestorContainer;
                
                let sourceContainer = container;
                while (sourceContainer && sourceContainer.nodeType !== Node.ELEMENT_NODE) {
                    sourceContainer = sourceContainer.parentNode;
                }
                
                let sourceTypeLocal = '';
                if (sourceContainer) {
                    if (sourceContainer.closest('#formatted-transcript') || sourceContainer.closest('#detailed-transcript')) {
                        sourceTypeLocal = 'transcript';
                    } else if (sourceContainer.closest('.summary-section')) {
                        sourceTypeLocal = 'summary';
                    }
                }
                
                if (sourceTypeLocal) {
                    showSnippetsButton(range, selectedTextContent, sourceTypeLocal);
                } else {
                    hideSnippetsButton();
                }
            } else {
                hideSnippetsButton();
            }
        }
        
        function showSnippetsButton(range, text, type) {
            const button = document.getElementById('snippetsAddBtn');
            const rect = range.getBoundingClientRect();
            
            // Store selection data
            selectedText = text;
            sourceType = type;
            
            // Position button below the selection
            button.style.left = Math.max(10, rect.left) + 'px';
            button.style.top = (rect.bottom + window.scrollY + 8) + 'px';
            button.style.display = 'block';
            
            // Hide button after 5 seconds
            setTimeout(() => {
                if (button.style.display === 'block') {
                    hideSnippetsButton();
                }
            }, 5000);
        }
        
        function hideSnippetsButton() {
            document.getElementById('snippetsAddBtn').style.display = 'none';
        }
        
        function addToSnippets() {
            if (!selectedText) {
                alert('No text selected. Please highlight some text first.');
                return;
            }
            
            const videoId = '{{ video_id }}';
            
            // Save snippet to database via API
            fetch('/api/snippets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    video_id: videoId,
                    snippet_text: selectedText,
                    source_type: sourceType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    alert('Snippet saved! ‚úÇÔ∏è\nVisit the Snippets page to view and manage your snippets.');
                    
                    // Hide the button
                    hideSnippetsButton();
                    
                    // Clear selection
                    if (window.getSelection) {
                        window.getSelection().removeAllRanges();
                    }
                    
                    // Temporarily highlight the saved text
                    highlightSavedText();
                } else {
                    alert('Failed to save snippet: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Failed to save snippet: ' + error.message);
            });
        }
        
        function highlightSavedText() {
            try {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const span = document.createElement('span');
                    span.className = 'memory-selection-highlight';
                    span.style.animation = 'pulse 2s ease-in-out';
                    
                    range.surroundContents(span);
                    
                    // Remove highlight after 3 seconds
                    setTimeout(() => {
                        if (span.parentNode) {
                            const parent = span.parentNode;
                            parent.insertBefore(document.createTextNode(span.textContent), span);
                            parent.removeChild(span);
                        }
                    }, 3000);
                }
            } catch (e) {
                // If highlighting fails (e.g., range spans multiple elements), just skip it
                console.log('Could not highlight saved text:', e);
            }
        }
        
        function addSnippetButtonsToExistingSummary() {
            // Find existing summary content and add snippet buttons to headers
            const summaryContent = document.querySelector('.summary-content .markdown-content');
            if (!summaryContent) return;
            
            // Find all headers in the summary
            const headers = summaryContent.querySelectorAll('h1, h2, h3');
            headers.forEach(header => {
                // Skip if already has a button
                if (header.querySelector('button')) return;
                
                const headerText = header.textContent.trim();
                const buttonId = 'snippet-btn-' + Math.random().toString(36).substr(2, 9);
                
                // Create button based on header level
                let buttonStyle = '';
                if (header.tagName === 'H1') {
                    buttonStyle = 'padding: 8px 16px; font-size: 14px; margin-left: 10px;';
                } else if (header.tagName === 'H2') {
                    buttonStyle = 'padding: 6px 12px; font-size: 13px; margin-left: 10px;';
                } else {
                    buttonStyle = 'padding: 4px 8px; font-size: 12px; margin-left: 10px;';
                }
                
                // Create and add the button
                const button = document.createElement('button');
                button.id = buttonId;
                button.innerHTML = '‚úÇÔ∏è Copy to Snippets';
                button.setAttribute('onclick', `copyChapterToSnippets('${headerText.replace(/'/g, "\\'")}', this)`);
                button.style.cssText = `background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; ${buttonStyle}`;
                
                // Style the header to flex layout
                header.style.display = 'flex';
                header.style.justifyContent = 'space-between';
                header.style.alignItems = 'center';
                header.style.margin = header.tagName === 'H1' ? '30px 0 20px 0' : header.tagName === 'H2' ? '25px 0 15px 0' : '20px 0 10px 0';
                
                header.appendChild(button);
            });
        }
        
        function copyChapterToSnippets(chapterTitle, buttonElement) {
            const videoId = '{{ video_id }}';
            
            // Find the chapter content - get all text from this header until the next header
            const headerElement = buttonElement.parentElement;
            let chapterContent = chapterTitle + '\n\n';
            
            // Get the next sibling elements until we hit another header
            let nextElement = headerElement.nextElementSibling;
            while (nextElement && !nextElement.matches('h1, h2, h3')) {
                if (nextElement.textContent && nextElement.textContent.trim()) {
                    chapterContent += nextElement.textContent.trim() + '\n\n';
                }
                nextElement = nextElement.nextElementSibling;
            }
            
            // Clean up the content
            chapterContent = chapterContent.trim();
            
            // Change button to loading state
            const originalText = buttonElement.innerHTML;
            buttonElement.innerHTML = '‚è≥ Saving...';
            buttonElement.disabled = true;
            buttonElement.style.background = '#666';
            
            // Save snippet to database via API
            fetch('/api/snippets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    video_id: videoId,
                    snippet_text: chapterContent,
                    source_type: 'summary'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success state
                    buttonElement.innerHTML = '‚úÖ Saved!';
                    buttonElement.style.background = '#4caf50';
                    
                    // Reset button after 3 seconds
                    setTimeout(() => {
                        buttonElement.innerHTML = originalText;
                        buttonElement.disabled = false;
                        buttonElement.style.background = '#4caf50';
                    }, 3000);
                } else {
                    // Show error
                    buttonElement.innerHTML = '‚ùå Error';
                    buttonElement.style.background = '#f44336';
                    alert('Failed to save snippet: ' + (data.error || 'Unknown error'));
                    
                    // Reset button after 3 seconds
                    setTimeout(() => {
                        buttonElement.innerHTML = originalText;
                        buttonElement.disabled = false;
                        buttonElement.style.background = '#4caf50';
                    }, 3000);
                }
            })
            .catch(error => {
                // Show error
                buttonElement.innerHTML = '‚ùå Error';
                buttonElement.style.background = '#f44336';
                alert('Failed to save snippet: ' + error.message);
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    buttonElement.innerHTML = originalText;
                    buttonElement.disabled = false;
                    buttonElement.style.background = '#4caf50';
                }, 3000);
            });
        }
        
        function toggleTranscriptView() {
            const formattedDiv = document.getElementById('formatted-transcript');
            const detailedDiv = document.getElementById('detailed-transcript');
            const toggleBtn = document.getElementById('toggleBtn');
            
            if (formattedDiv.style.display === 'none') {
                // Show formatted, hide detailed
                formattedDiv.style.display = 'block';
                detailedDiv.style.display = 'none';
                toggleBtn.textContent = 'üìñ Switch to Detailed View';
            } else {
                // Show detailed, hide formatted
                formattedDiv.style.display = 'none';
                detailedDiv.style.display = 'block';
                toggleBtn.textContent = 'üìÑ Switch to Readable View';
            }
        }
        
        function scrollToChapter(chapterTime) {
            const formattedDiv = document.getElementById('formatted-transcript');
            const detailedDiv = document.getElementById('detailed-transcript');
            const chapterId = 'chapter-' + chapterTime;
            
            if (formattedDiv.style.display !== 'none') {
                // In formatted view - scroll to the chapter anchor
                const chapterAnchor = document.getElementById(chapterId);
                if (chapterAnchor) {
                    chapterAnchor.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    // Highlight the section temporarily
                    const formattedContent = document.getElementById('formatted-transcript-content');
                    const originalBg = formattedContent.parentElement.style.backgroundColor;
                    formattedContent.parentElement.style.backgroundColor = '#fff3cd';
                    setTimeout(() => {
                        formattedContent.parentElement.style.backgroundColor = originalBg;
                    }, 2000);
                } else {
                    // Fallback: scroll to formatted transcript
                    const formattedContent = document.getElementById('formatted-transcript-content');
                    formattedContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            } else {
                // In detailed view - find the closest timestamp entry
                const timestampEntries = document.querySelectorAll('.transcript-entry[data-time]');
                let closestEntry = null;
                let closestDiff = Infinity;
                
                timestampEntries.forEach(entry => {
                    const entryTime = parseInt(entry.getAttribute('data-time'));
                    const diff = Math.abs(entryTime - chapterTime);
                    if (diff < closestDiff) {
                        closestDiff = diff;
                        closestEntry = entry;
                    }
                });
                
                if (closestEntry) {
                    closestEntry.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    // Highlight the entry temporarily
                    const originalBg = closestEntry.style.backgroundColor;
                    closestEntry.style.backgroundColor = '#fff3cd';
                    closestEntry.style.borderLeft = '4px solid #ffc107';
                    closestEntry.style.paddingLeft = '10px';
                    setTimeout(() => {
                        closestEntry.style.backgroundColor = originalBg;
                        closestEntry.style.borderLeft = '';
                        closestEntry.style.paddingLeft = '';
                    }, 2000);
                }
            }
        }
        
        function convertMarkdownToHtml(markdown) {
            let html = markdown;
            
            // Convert headers with snippet buttons (## Header -> <h2>Header <button>...</button></h2>)
            html = html.replace(/^### (.+)$/gm, (match, title) => {
                const buttonId = 'snippet-btn-' + Math.random().toString(36).substr(2, 9);
                return `<h3 style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0 10px 0; flex-wrap: wrap; gap: 10px;">${title} <button id="${buttonId}" onclick="copyChapterToSnippets('${title.replace(/'/g, "\\'")}', this)" style="background: #4caf50; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 10px; flex-shrink: 0;">‚úÇÔ∏è Copy to Snippets</button></h3>`;
            });
            html = html.replace(/^## (.+)$/gm, (match, title) => {
                const buttonId = 'snippet-btn-' + Math.random().toString(36).substr(2, 9);
                return `<h2 style="display: flex; justify-content: space-between; align-items: center; margin: 25px 0 15px 0; flex-wrap: wrap; gap: 10px;">${title} <button id="${buttonId}" onclick="copyChapterToSnippets('${title.replace(/'/g, "\\'")}', this)" style="background: #4caf50; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; margin-left: 10px; flex-shrink: 0;">‚úÇÔ∏è Copy to Snippets</button></h2>`;
            });
            html = html.replace(/^# (.+)$/gm, (match, title) => {
                const buttonId = 'snippet-btn-' + Math.random().toString(36).substr(2, 9);
                return `<h1 style="display: flex; justify-content: space-between; align-items: center; margin: 30px 0 20px 0; flex-wrap: wrap; gap: 10px;">${title} <button id="${buttonId}" onclick="copyChapterToSnippets('${title.replace(/'/g, "\\'")}', this)" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 10px; flex-shrink: 0;">‚úÇÔ∏è Copy to Snippets</button></h1>`;
            });
            
            // Convert **bold** to <strong>bold</strong>
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Convert *italic* to <em>italic</em>
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            
            // Convert [text](url) to <a href="url" target="_blank">text</a>
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // Convert bullet lists (- item or * item)
            html = html.replace(/^[-*] (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            
            // Convert numbered lists (1. item)
            html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
            
            // Convert line breaks to paragraphs
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';
            
            // Clean up empty paragraphs
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p>(<h[1-6]>)/g, '$1');
            html = html.replace(/(<\/h[1-6]>)<\/p>/g, '$1');
            html = html.replace(/<p>(<ul>)/g, '$1');
            html = html.replace(/(<\/ul>)<\/p>/g, '$1');
            
            return html;
        }
        
        function generateSummary(videoId) {
            const btn = document.getElementById('generateSummaryBtn');
            const summarySection = document.getElementById('summary-section');
            
            // Get formatted transcript text (readable version, not detailed timestamps)
            const formattedTranscript = {{ formatted_transcript|tojson }};
            
            // Update button to show loading state
            btn.textContent = '‚è≥ Generating...';
            btn.disabled = true;
            btn.style.background = '#666';
            
            // Make AJAX request to generate summary with formatted transcript
            fetch('/api/summary', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    video_id: videoId,
                    formatted_transcript: formattedTranscript
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Convert markdown to HTML
                        const summaryHtml = convertMarkdownToHtml(data.summary);
                        
                        // Show summary section
                        summarySection.style.display = 'block';
                        summarySection.innerHTML = `
                            <div class="summary-section">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="margin: 0;">ü§ñ AI-Generated Summary:</h3>
                                    <button id="regenerateSummaryBtn" onclick="regenerateSummary('${videoId}')" style="background: #ff9800; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">üîÑ Regenerate</button>
                                </div>
                                <div class="summary-content">
                                    <div class="markdown-content">${summaryHtml}</div>
                                </div>
                            </div>
                            <hr style="margin: 30px 0; border: 1px solid #ddd;">
                        `;
                        
                        // Update the button text to indicate it can regenerate
                        btn.textContent = 'ü§ñ Regenerate AI Summary';
                        btn.disabled = false;
                        btn.style.background = '#2196f3';
                    } else {
                        // Show error
                        summarySection.style.display = 'block';
                        summarySection.innerHTML = `
                            <div class="summary-error">
                                <h3>‚ùå Summary Error:</h3>
                                <p style="color: #d32f2f;">${data.error}</p>
                            </div>
                            <hr style="margin: 30px 0; border: 1px solid #ddd;">
                        `;
                        
                        // Reset button
                        btn.textContent = 'ü§ñ Generate AI Summary';
                        btn.disabled = false;
                        btn.style.background = '#2196f3';
                    }
                })
                .catch(error => {
                    // Show error
                    summarySection.style.display = 'block';
                    summarySection.innerHTML = `
                        <div class="summary-error">
                            <h3>‚ùå Summary Error:</h3>
                            <p style="color: #d32f2f;">Failed to generate summary: ${error.message}</p>
                        </div>
                        <hr style="margin: 30px 0; border: 1px solid #ddd;">
                    `;
                    
                    // Reset button
                    btn.textContent = 'ü§ñ Generate AI Summary';
                    btn.disabled = false;
                    btn.style.background = '#2196f3';
                });
        }
        
        function regenerateSummary(videoId) {
            const btn = document.getElementById('regenerateSummaryBtn');
            const summarySection = document.getElementById('summary-section');
            
            // Get formatted transcript text (readable version, not detailed timestamps)
            const formattedTranscript = {{ formatted_transcript|tojson }};
            
            // Update button to show loading state
            btn.textContent = '‚è≥ Regenerating...';
            btn.disabled = true;
            btn.style.background = '#666';
            
            // Make AJAX request to generate summary with formatted transcript
            fetch('/api/summary', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    video_id: videoId,
                    formatted_transcript: formattedTranscript
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Convert markdown to HTML
                        const summaryHtml = convertMarkdownToHtml(data.summary);
                        
                        // Update summary section with new content
                        summarySection.innerHTML = `
                            <div class="summary-section">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="margin: 0;">ü§ñ AI-Generated Summary:</h3>
                                    <button id="regenerateSummaryBtn" onclick="regenerateSummary('${videoId}')" style="background: #ff9800; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">üîÑ Regenerate</button>
                                </div>
                                <div class="summary-content">
                                    <div class="markdown-content">${summaryHtml}</div>
                                </div>
                            </div>
                            <hr style="margin: 30px 0; border: 1px solid #ddd;">
                        `;
                        
                        // Update the main generate button
                        const mainBtn = document.getElementById('generateSummaryBtn');
                        if (mainBtn) {
                            mainBtn.textContent = 'ü§ñ Regenerate AI Summary';
                            mainBtn.disabled = false;
                            mainBtn.style.background = '#2196f3';
                        }
                    } else {
                        // Show error but keep the regenerate button
                        summarySection.innerHTML = `
                            <div class="summary-error">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="margin: 0;">‚ùå Summary Error:</h3>
                                    <button id="regenerateSummaryBtn" onclick="regenerateSummary('${videoId}')" style="background: #ff9800; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">üîÑ Regenerate</button>
                                </div>
                                <p style="color: #d32f2f;">${data.error}</p>
                            </div>
                            <hr style="margin: 30px 0; border: 1px solid #ddd;">
                        `;
                    }
                })
                .catch(error => {
                    // Show error but keep the regenerate button
                    summarySection.innerHTML = `
                        <div class="summary-error">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0;">‚ùå Summary Error:</h3>
                                <button id="regenerateSummaryBtn" onclick="regenerateSummary('${videoId}')" style="background: #ff9800; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">üîÑ Regenerate</button>
                            </div>
                            <p style="color: #d32f2f;">Failed to generate summary: ${error.message}</p>
                        </div>
                        <hr style="margin: 30px 0; border: 1px solid #ddd;">
                    `;
                });
        }
    </script>
    
{% endblock %}